---
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogList from "../../components/BlogList.astro";
import PodcastList from "../../components/PodcastList.astro";
import Button from "../../components/Button.astro";
import Icon from "../../components/Icon.astro";
import Window from "../../components/Window.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { getAuthor, getAuthorIds } from "../../data/authors";
import { Image } from "astro:assets";
import { marked } from "marked";

const { author: authorSlug } = Astro.params;
const authorData = getAuthor(authorSlug as string);

if (!authorData) {
  return Astro.redirect("/404");
}

const allPosts = await getCollection("blog");
const authorPosts = allPosts
  .filter((post: CollectionEntry<"blog">) => {
    return post.data.author === authorSlug;
  })
  .sort(
    (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
      b.data.date.valueOf() - a.data.date.valueOf(),
  );

const allPodcasts = await getCollection("podcasts");
const authorPodcasts = allPodcasts
  .filter((podcast: CollectionEntry<"podcasts">) => {
    return podcast.data.hosts.includes(authorSlug as string);
  })
  .sort(
    (a: CollectionEntry<"podcasts">, b: CollectionEntry<"podcasts">) =>
      b.data.date.valueOf() - a.data.date.valueOf(),
  );

const bioHtml = authorData.bio ? await marked(authorData.bio) : null;

export async function getStaticPaths() {
  const authorIds = getAuthorIds();

  return authorIds.map((id) => ({
    params: { author: id },
  }));
}
---

<BaseLayout title={authorData.name}>
  <div class="author-page">
    <Window title="author.info()" class="author-header">
      <div class="author-info">
        <div class="author-avatar">
          {
            authorData.avatar ? (
              typeof authorData.avatar === "string" ? (
                <img src={authorData.avatar} alt={authorData.name} />
              ) : (
                <Image
                  src={authorData.avatar}
                  alt={authorData.name}
                  width={400}
                  height={400}
                  quality={100}
                />
              )
            ) : (
              <Icon name="user" size={32} />
            )
          }
        </div>
        <div class="author-details">
          <h1>{authorData.name}</h1>
          {bioHtml && <div class="bio" set:html={bioHtml} />}
          {
            authorData.links && (
              <div class="author-links">
                {authorData.links.github && (
                  <Button
                    href={authorData.links.github}
                    icon="github"
                    iconSize={16}
                    target="_blank"
                  >
                    github
                  </Button>
                )}
                {authorData.links.linkedin && (
                  <Button
                    href={authorData.links.linkedin}
                    icon="linkedin"
                    iconSize={16}
                    target="_blank"
                  >
                    linkedin
                  </Button>
                )}
                {authorData.links.website && (
                  <Button
                    href={authorData.links.website}
                    icon="globe"
                    iconSize={16}
                    target="_blank"
                  >
                    website
                  </Button>
                )}
              </div>
            )
          }
        </div>
      </div>
    </Window>

    <section class="author-posts">
      <div class="section-header">
        <h2><span class="comment">// </span>yazılar ({authorPosts.length})</h2>
      </div>

      <BlogList posts={authorPosts} />
    </section>

    <section class="author-podcasts">
      <div class="section-header">
        <h2>
          <span class="comment">// </span>söhbətlər ({authorPodcasts.length})
        </h2>
      </div>

      <PodcastList podcasts={authorPodcasts} />
    </section>
  </div>
</BaseLayout>

<style>
  .author-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  /* Author Info */
  .author-info {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .author-avatar {
    width: 120px;
    height: 120px;
    border-radius: var(--radius-lg);
    background: var(--color-surface);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary);
    overflow: hidden;
    flex-shrink: 0;
  }

  .author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .author-details h1 {
    font-family: var(--font-mono);
    font-size: 1.5rem;
    color: var(--color-green);
    margin-bottom: 0.5rem;
  }

  .bio {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    margin-bottom: 0.75rem;
  }

  .author-links {
    display: flex;
    gap: 0.5rem;
  }

  @media (max-width: 768px) {
    .author-info {
      flex-direction: column;
      text-align: center;
    }

    .author-links {
      justify-content: center;
    }
  }
</style>
